<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ガーデン八潮総合BOT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f8fafc; color: #1e2b3b; overflow-x: hidden; }
        .fade-in { animation: fadeIn 0.7s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content { animation: modalIn 0.3s ease-out forwards; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(79, 70, 229, 0.2); }
        .slider-wrapper { display: flex; transition: transform 0.5s ease-in-out; }
        .calendar-day { width: 100%; aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; position: relative; }
        .calendar-day:hover:not(.empty-day) { background-color: #f4f4f5; }
        .calendar-day.has-event::after { content: ''; position: absolute; bottom: 12%; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; border-radius: 50%; background-color: #ef4444; }
        .calendar-day.is-today { background-color: #fef9c3; border-color: #eab308; font-weight: 700; }
        .calendar-day.is-selected { background-color: #e0e7ff; border-color: #4f46e5; font-weight: 700; }
        /* モーダル内のスクロールバーを見やすく */
        .overflow-y-auto::-webkit-scrollbar { width: 8px; }
        .overflow-y-auto::-webkit-scrollbar-track { background: #f1f1f1; }
        .overflow-y-auto::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white/80 backdrop-blur-md border-b border-gray-200/80 sticky top-0 z-20">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <a href="#" class="flex items-center">
                    <img src="rogo.jpg" alt="ロゴ" class="h-6 w-auto mr-2" onerror="this.style.display='none'">
                    <span class="text-xl font-bold text-gray-800">ガーデン八潮総合BOT</span>
                </a>
                <span id="currentDate" class="text-sm font-medium text-gray-700"></span>
            </div>
        </div>
    </header>

    <main>
        <!-- Slider Section -->
        <section class="bg-white pb-10">
             <div class="w-full bg-white py-8">
                <div class="relative w-[90%] max-w-[800px] mx-auto overflow-hidden rounded-xl shadow-md">
                    <div class="slider-wrapper flex transition-transform duration-500">
                        <div class="min-w-full aspect-video bg-black"><img src="sinsou1.jpg" class="w-full h-full object-contain" alt="新装開店"></div>
                    </div>
                </div>
            </div>
            <div class="container mx-auto px-4 text-center">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">最新台情報をチェック</h1>
            </div>
        </section>

        <!-- New Opening Button -->
        <section class="pb-10 bg-slate-50">
            <div class="container mx-auto px-4 -mt-10">
                <div id="newOpeningButton" class="cursor-pointer bg-white rounded-2xl shadow-lg border border-gray-200 p-8 text-center max-w-md mx-auto hover:shadow-xl transition-shadow">
                    <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-lg bg-indigo-100 mb-4">
                        <svg class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900">新装開店の情報を見る</h3>
                    <p class="text-gray-600 mt-2">最新の導入機種とスペックをチェック</p>
                </div>
            </div>
        </section>

        <!-- Slot Team Info -->
        <section class="py-10 bg-slate-50">
            <div class="container mx-auto px-4">
                <details class="group max-w-4xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden" open>
                    <summary class="cursor-pointer flex justify-between items-center p-6 bg-white hover:bg-gray-50 transition-colors">
                        <h2 class="text-2xl font-bold text-gray-900">スロットチームからのご案内</h2>
                        <svg class="h-6 w-6 text-gray-500 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div class="p-6 border-t border-gray-100">
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-red-600 mb-2">年一の祭典「28日」に向けた集大成ウィーク</h3>
                            <p class="text-gray-600">11月ラスト、定休日なしで駆け抜けます！</p>
                        </div>
                        
                        <div class="space-y-6">
                            <!-- Events -->
                            <div class="border-l-4 border-indigo-500 pl-4">
                                <h4 class="font-bold text-lg text-indigo-800">11/24 (月)</h4>
                                <p class="text-sm font-bold text-gray-600">極上マッティーさん × みーまるさん W来店</p>
                                <p class="text-sm text-gray-700 mt-1">スロット全般＆物販開催。朝からの盛り上がり必至！</p>
                            </div>
                            <div class="border-l-4 border-gray-400 pl-4">
                                <h4 class="font-bold text-lg text-gray-800">11/25 (火) ～ 27 (木)</h4>
                                <p class="text-sm font-bold text-gray-600">夕方時差狙い & 月周年</p>
                                <p class="text-sm text-gray-700 mt-1">27日は月周年日2nd！ポンコツ珍道中収録で環境・出玉を徹底アピール。</p>
                            </div>
                            <div class="border-l-4 border-red-600 pl-4 bg-red-50 p-2 rounded-r">
                                <h4 class="font-bold text-lg text-red-600">11/28 (金) 年一「1128」× 8の日</h4>
                                <p class="text-sm font-bold text-gray-800">八潮上空 / 真骨超 / くずパチ収録</p>
                                <p class="text-sm text-gray-700 mt-1">年一のお祭り日。真骨超(スロ)＆くずパチ(パチ)のWインパクト！</p>
                            </div>
                            <div class="border-l-4 border-green-500 pl-4">
                                <h4 class="font-bold text-lg text-gray-800">11/29-30 週末</h4>
                                <p class="text-sm text-gray-700 mt-1">29日:天草さん+くろむさん(塊狙い) / 30日:スロパチ埼玉+MAXBET</p>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        </section>

        <!-- Calendar -->
        <section class="py-10 bg-white">
            <div class="container mx-auto px-4 text-center">
                <h2 id="calendarTitle" class="text-3xl font-bold text-gray-900 mb-6">本日のイベント</h2>
                <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                    <div id="todayEventContainer" class="p-8">Loading...</div>
                    <div id="fullCalendarContainer" class="hidden p-6">
                        <div id="calendarGrid" class="grid grid-cols-7 gap-1 mb-4"></div>
                        <div id="selectedEventDetails" class="text-left border-t pt-4"></div>
                    </div>
                </div>
                <button id="calendarToggleButton" class="mt-6 bg-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow hover:bg-indigo-700 transition">11月のカレンダーを見る</button>
            </div>
        </section>

        <!-- Floor Map -->
        <section class="py-10 bg-slate-50">
            <div class="container mx-auto px-4 text-center">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">フロアマップ</h2>
                <div class="max-w-4xl mx-auto bg-white p-2 rounded-xl shadow">
                    <img src="simazu.jpg" alt="Map" class="w-full rounded" onerror="this.parentNode.innerHTML='<div class=\'p-10 text-gray-400\'>マップ画像読み込みエラー</div>'">
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-white py-8 text-center text-gray-500">
        &copy; 2025 ガーデン八潮総合BOT
    </footer>

    <!-- Modals -->
    <!-- New Opening List Modal -->
    <div id="newOpeningModal" class="fixed inset-0 bg-black/60 hidden z-40 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg">新装開店リスト</h3>
                <button id="closeNewOpeningModal" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="newOpeningInfo" class="p-4 overflow-y-auto bg-white"></div>
        </div>
    </div>

    <!-- Machine Detail Modal -->
    <div id="machineDetailModal" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-indigo-600 p-4 flex justify-between items-center text-white shrink-0">
                <h3 id="detailName" class="font-bold text-xl"></h3>
                <button id="closeDetailModal" class="text-3xl leading-none hover:text-indigo-200">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="mb-6">
                    <h4 class="text-xs font-bold text-indigo-500 uppercase mb-2">セールスポイント</h4>
                    <p id="detailPitch" class="text-gray-800 text-lg leading-relaxed font-medium"></p>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                        <h5 class="text-green-800 font-bold mb-2 flex items-center">Good!</h5>
                        <ul id="detailPros" class="text-sm text-green-900 space-y-1 list-disc list-inside"></ul>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                        <h5 class="text-red-800 font-bold mb-2 flex items-center">Bad...</h5>
                        <ul id="detailCons" class="text-sm text-red-900 space-y-1 list-disc list-inside"></ul>
                    </div>
                </div>
                <!-- DMMリンク削除 -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAdxAeBlJkFWAVM1ZWJKhU2urQcmtL0UKo",
          authDomain: "gardenyashiobot.firebaseapp.com",
          projectId: "gardenyashiobot",
          storageBucket: "gardenyashiobot.firebasestorage.app",
          messagingSenderId: "692971442685",
          appId: "1:692971442685:web:ae4a65988ad1716ed84994"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allMachines = [];
        let newOpeningData = [];
        let calendarEvents = [];
        let eventMap = new Map();

        const $ = s => document.querySelector(s);
        const $$ = s => document.querySelectorAll(s);

        // 12月8日導入（最新）として扱う機種名のキーワード
        const latestKeywords = [
            "アズールレーン",
            "北斗の拳11",
            "地獄少女7500",
            "炎炎ノ消防隊2MS",
            "海物語極ジャパン",
            "化物語",
            "プリズムナナ",
            "バーニングエキスプレス"
        ];

        // Data Fetch
        async function fetchData() {
            try {
                const mSnap = await getDocs(query(collection(db, "machines"), orderBy("name")));
                allMachines = mSnap.docs.map(d => d.data());

                const nSnap = await getDocs(query(collection(db, "newOpening"))); 
                newOpeningData = nSnap.docs.map(d => d.data());
                // 台数順にソート (ここでは全体ソートだが、後で分割して再ソートする)
                newOpeningData.sort((a,b) => b.count - a.count);

                const cSnap = await getDocs(query(collection(db, "calendar"), orderBy("date")));
                calendarEvents = cSnap.docs.map(d => d.data());
                eventMap = new Map(calendarEvents.map(e => [e.date, e]));

                renderToday();
            } catch (e) {
                console.error("Data Load Error:", e);
                $("#todayEventContainer").textContent = "データの読み込みに失敗しました。";
            }
        }

        // New Opening Modal Logic (Split by Date & Sort by Count)
        function openNewOpening() {
            const container = $("#newOpeningInfo");
            container.innerHTML = "";
            
            if (newOpeningData.length === 0) {
                container.innerHTML = "<p class='text-center text-gray-500'>データがありません。</p>";
                $("#newOpeningModal").classList.remove("hidden");
                return;
            }

            // 分割処理
            const latest = [];
            const others = [];

            newOpeningData.forEach(m => {
                const isLatest = latestKeywords.some(k => m.name.includes(k));
                if(isLatest) latest.push(m);
                else others.push(m);
            });

            // それぞれ台数順にソート
            latest.sort((a,b) => b.count - a.count);
            others.sort((a,b) => b.count - a.count);

            // リスト作成関数
            const createList = (list) => {
                const ul = document.createElement("ul");
                ul.className = "space-y-2 mb-6";
                list.forEach(item => {
                    const li = document.createElement("li");
                    li.className = "flex justify-between items-center bg-gray-50 p-3 rounded border hover:bg-slate-100 transition-colors";
                    
                    const clean = s => s.replace(/\s+/g, '').toLowerCase();
                    const matched = allMachines.find(m => 
                        m.name === item.name || 
                        m.name.includes(item.name) || 
                        clean(m.name) === clean(item.name)
                    );

                    if (matched && matched.salesPitch) {
                        const btn = document.createElement("button");
                        btn.className = "text-indigo-600 font-bold hover:underline text-left flex-1 truncate mr-2";
                        btn.innerHTML = `${item.name}`;
                        btn.onclick = () => openDetail(matched);
                        li.appendChild(btn);
                    } else {
                        const span = document.createElement("span");
                        span.className = "font-medium text-gray-800 flex-1 truncate mr-2";
                        span.textContent = item.name;
                        li.appendChild(span);
                    }

                    const badge = document.createElement("span");
                    badge.className = "text-sm font-bold bg-indigo-600 text-white px-3 py-1 rounded-full shrink-0";
                    badge.textContent = `${item.count}台`;
                    li.appendChild(badge);
                    ul.appendChild(li);
                });
                return ul;
            };

            // 最新導入エリア
            if(latest.length > 0) {
                const h3 = document.createElement("h3");
                h3.className = "text-lg font-bold text-red-600 mb-3 flex items-center bg-red-50 p-2 rounded";
                h3.innerHTML = "✨ 12月8日 最新導入";
                container.appendChild(h3);
                container.appendChild(createList(latest));
            }

            // その他エリア
            if(others.length > 0) {
                const h3 = document.createElement("h3");
                h3.className = "text-lg font-bold text-gray-700 mb-3 flex items-center bg-gray-100 p-2 rounded";
                h3.innerHTML = "⭐ 準新台・その他";
                container.appendChild(h3);
                container.appendChild(createList(others));
            }

            $("#newOpeningModal").classList.remove("hidden");
        }

        // Detail Modal
        function openDetail(data) {
            $("#detailName").textContent = data.name;
            $("#detailPitch").textContent = data.salesPitch || "情報なし";
            
            const fillList = (id, list) => {
                const el = $(id);
                el.innerHTML = "";
                (list || ["情報なし"]).forEach(t => {
                    const li = document.createElement("li");
                    li.textContent = t;
                    el.appendChild(li);
                });
            };
            fillList("#detailPros", data.pros);
            fillList("#detailCons", data.cons);
            
            // Link is removed
            $("#machineDetailModal").classList.remove("hidden");
        }

        // Calendar Logic
        function renderToday() {
            const today = new Date();
            const d = today.getDate();
            const m = today.getMonth(); // 11月=10
            
            if (m !== 10) {
                $("#todayEventContainer").innerHTML = "<p class='text-gray-500'>11月ではありません。</p>";
                return;
            }
            
            const ev = eventMap.get(d);
            const html = ev 
                ? `<h3 class='text-xl font-bold text-indigo-700 mb-2'>11/${d} のイベント</h3>
                   <ul class='list-disc pl-5 space-y-1'>
                     ${ev.p_event ? `<li>${ev.p_event}</li>` : ''}
                     ${ev.s_event ? `<li>${ev.s_event}</li>` : ''}
                     ${ev.recommend ? `<li>${ev.recommend}</li>` : ''}
                   </ul>`
                : `<p class='text-gray-500'>11/${d} の特別イベントはありません。</p>`;
            $("#todayEventContainer").innerHTML = html;
            $("#currentDate").textContent = `2025年11月${d}日`;
        }

        function renderFullCalendar() {
            const grid = $("#calendarGrid");
            grid.innerHTML = `<div class="font-bold text-xs text-gray-400 py-1">日</div><div class="font-bold text-xs text-gray-400 py-1">月</div><div class="font-bold text-xs text-gray-400 py-1">火</div><div class="font-bold text-xs text-gray-400 py-1">水</div><div class="font-bold text-xs text-gray-400 py-1">木</div><div class="font-bold text-xs text-gray-400 py-1">金</div><div class="font-bold text-xs text-gray-400 py-1">土</div>`;
            
            // 2025 Nov 1st is Saturday (6)
            for(let i=0; i<6; i++) grid.innerHTML += `<div></div>`;
            
            for(let i=1; i<=30; i++) {
                const ev = eventMap.get(i);
                const hasEv = ev && (ev.p_event || ev.s_event);
                const btn = document.createElement("button");
                btn.className = `calendar-day ${hasEv ? 'has-event' : ''}`;
                btn.textContent = i;
                btn.onclick = () => {
                    $$(".calendar-day").forEach(b => b.classList.remove("is-selected"));
                    btn.classList.add("is-selected");
                    
                    const detail = $("#selectedEventDetails");
                    if(ev) {
                         detail.innerHTML = `<h4 class='font-bold text-indigo-600 mb-2'>11/${i} 詳細</h4>
                           <ul class='list-disc pl-5 text-sm space-y-1'>
                             ${ev.p_event ? `<li>${ev.p_event}</li>` : ''}
                             ${ev.s_event ? `<li>${ev.s_event}</li>` : ''}
                             ${ev.recommend ? `<li>${ev.recommend}</li>` : ''}
                           </ul>`;
                    } else {
                        detail.innerHTML = `<p class='text-gray-500 text-sm'>11/${i} のイベント情報はありません。</p>`;
                    }
                };
                grid.appendChild(btn);
            }
        }

        // Event Listeners
        window.addEventListener("load", fetchData);
        $("#newOpeningButton").onclick = openNewOpening;
        $("#closeNewOpeningModal").onclick = () => $("#newOpeningModal").classList.add("hidden");
        $("#closeDetailModal").onclick = () => $("#machineDetailModal").classList.add("hidden");
        $("#calendarToggleButton").onclick = () => {
            const full = $("#fullCalendarContainer");
            const today = $("#todayEventContainer");
            const btn = $("#calendarToggleButton");
            
            if (full.classList.contains("hidden")) {
                full.classList.remove("hidden");
                today.classList.add("hidden");
                btn.textContent = "本日のイベントに戻る";
                renderFullCalendar();
            } else {
                full.classList.add("hidden");
                today.classList.remove("hidden");
                btn.textContent = "11月のカレンダーを見る";
            }
        };

        // Slider (Simple)
        let sIdx = 0;
        setInterval(() => {
        }, 5000);

    </script>
</body>
</html>
