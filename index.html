<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ガーデン八潮総合BOT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
            color: #1e2b3b;
            overflow-x: hidden;
        }
        .fade-in { animation: fadeIn 0.7s ease-in-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-content { animation: modalIn 0.5s ease-in-out forwards; }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .btn-primary { transition: all 0.3s ease; }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.2);
        }
        .feature-card { transition: all 0.3s ease; }
        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .slider-outer-container { width: 100%; padding: 2rem 0; background-color: white; }
        .slider-container { position: relative; width: 90%; max-width: 800px; margin: 0 auto; overflow: hidden; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .slider-wrapper { display: flex; transition: transform 0.5s ease-in-out; }
        .slide { min-width: 100%; box-sizing: border-box; aspect-ratio: 16 / 9; background-color: #000; }
        .slide img { width: 100%; height: 100%; display: block; object-fit: contain; }
        .prev, .next { cursor: pointer; position: absolute; top: 50%; transform: translateY(-50%); width: auto; padding: 16px; color: white; font-weight: bold; font-size: 20px; transition: 0.3s ease; border-radius: 50%; user-select: none; background-color: rgba(0,0,0,0.4); line-height: 1; z-index: 10; }
        .prev { left: 10px; }
        .next { right: 10px; }
        .prev:hover, .next:hover { background-color: rgba(0,0,0,0.7); }
        .dots-container { text-align: center; padding-top: 15px; padding-bottom: 10px; }
        .dot { cursor: pointer; height: 12px; width: 12px; margin: 0 4px; background-color: #bbb; border-radius: 50%; display: inline-block; transition: background-color 0.3s ease; }
        .dot.active { background-color: #4f46e5; }
        .calendar-day { width: 100%; aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-medium: 500; cursor: pointer; transition: all 0.2s ease; position: relative; border: 2px solid transparent; color: #374151; }
        .calendar-day:hover:not(.empty-day) { background-color: #f4f4f5; }
        .calendar-day.empty-day { cursor: default; }
        .calendar-day.has-event::after { content: ''; position: absolute; bottom: 12%; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; border-radius: 50%; background-color: #ef4444; }
        .calendar-day.is-today { background-color: #fef9c3; border-color: #eab308; font-weight: 700; }
        .calendar-day.is-selected { background-color: #e0e7ff; border-color: #4f46e5; font-weight: 700; color: #1e2b3b; }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white/80 backdrop-blur-md border-b border-gray-200/80 sticky top-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="#" class="flex items-center">
                    <img src="rogo.jpg" alt="ロゴ" class="h-6 w-auto mr-2">
                    <span class="text-xl font-bold text-gray-800">ガーデン八潮総合BOT</span>
                </a>
                <span id="currentDate" class="text-sm sm:text-base font-medium text-gray-700"></span>
            </div>
        </div>
    </header>

    <main>
        <section class="text-center bg-white pb-28 sm:pb-36">
             <div class="slider-outer-container">
                <div class="slider-container">
                    <div class="slider-wrapper">
                        <div class="slide"><img src="sinsou1.jpg" alt="新装開店画像1"></div>
                    </div>
                    <a class="prev">&#10094;</a>
                    <a class="next">&#10095;</a>
                </div>
                 <div class="dots-container">
                    <span class="dot active"></span>
                </div>
            </div>
            <div class="container mx-auto px-4 pt-10 lg:px-8">
                <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-gray-900">
                    最新台の情報をいつでも手軽に
                </h1>
            </div>
        </section>

        <section class="pb-20 bg-slate-50">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 -mt-20 sm:-mt-24">
                <div class="grid grid-cols-1 md:grid-cols-1 gap-8 max-w-md mx-auto">
                    <div id="newOpeningButton" class="feature-card cursor-pointer bg-white rounded-2xl shadow-lg border border-gray-200/80 p-8 text-center">
                        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-lg bg-indigo-100">
                            <svg class="h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>
                        </div>
                        <h3 class="mt-6 text-xl font-semibold text-gray-900">新装開店の情報を見る</h3>
                        <p class="mt-2 text-base text-gray-600">新装開店の情報をいち早く確認。</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-20 bg-white">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <details class="group max-w-6xl mx-auto" open>
                    <summary class="list-none cursor-pointer flex justify-between items-center text-left py-4 border-b border-gray-300">
                        <div class="text-center w-full"><h2 class="text-3xl font-extrabold tracking-tight text-gray-900 sm:text-4xl">ぱちんこチームからのご案内</h2></div>
                        <svg class="h-6 w-6 text-gray-500 group-open:rotate-180 transition-transform duration-300 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                    </summary>
                    <div class="pt-8 pb-4">
                        <div class="text-center py-12">
                            <p class="text-gray-500 text-lg">現在、ご案内情報は準備中です。</p>
                        </div>
                    </div>
                </details>
            </div>
        </section>

        <section class="py-20 bg-slate-50">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <details class="group max-w-6xl mx-auto" open>
                    <summary class="list-none cursor-pointer flex justify-between items-center text-left py-4 border-b border-gray-300">
                        <div class="text-center w-full"><h2 class="text-3xl font-extrabold tracking-tight text-gray-900 sm:text-4xl">スロットチームからのご案内</h2></div>
                        <svg class="h-6 w-6 text-gray-500 group-open:rotate-180 transition-transform duration-300 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                    </summary>
                    <div class="pt-8 pb-4">
                        <div class="text-center mb-10">
                            <p class="text-lg text-gray-600 font-medium">11月ラストの週、定休日なしで駆け抜けます！</p>
                            <h3 class="text-2xl font-bold text-red-600 mt-2">年一の祭典「28日」に向けた集大成ウィーク</h3>
                        </div>

                        <div class="relative border-l-4 border-indigo-300 ml-6 sm:ml-12 space-y-12">

                            <!-- 11/24 -->
                            <div class="ml-8 pl-4 relative">
                                <div class="absolute -left-14 sm:-left-14 top-1 w-8 h-8 bg-indigo-500 rounded-full border-4 border-white"></div>
                                <h4 class="text-xl font-bold text-indigo-800">11/24 (月) <span class="text-sm font-normal text-gray-600 ml-2">極上マッティーさん × みーまるさん W来店</span></h4>
                                <div class="mt-3 bg-white p-5 rounded-xl shadow-md border border-gray-200">
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        <span class="bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded">本人来店</span>
                                        <span class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded">3日目</span>
                                    </div>
                                    <p class="text-gray-700 font-medium">スロット全般・物販開催</p>
                                    <p class="text-gray-600 mt-1 text-sm">極上マッティーさんがスロット全般を実戦＆拡散。みーまるさんは時差からの参加（27日まで連続）。W来店で朝から盛り上げます！</p>
                                </div>
                            </div>

                            <!-- 11/25 - 27 -->
                            <div class="ml-8 pl-4 relative">
                                <div class="absolute -left-14 sm:-left-14 top-1 w-8 h-8 bg-gray-400 rounded-full border-4 border-white"></div>
                                <h4 class="text-xl font-bold text-gray-800">11/25 (火) ～ 27 (木) <span class="text-sm font-normal text-gray-600 ml-2">夕方時差狙い & 月周年</span></h4>
                                <div class="mt-3 bg-white p-5 rounded-xl shadow-md border border-gray-200">
                                    <ul class="list-disc list-inside space-y-2 text-sm text-gray-700">
                                        <li><span class="font-bold text-gray-900">25日～27日：</span>みーまるさん夕方17時から来店。時差開放をアピール。</li>
                                        <li><span class="font-bold text-gray-900">25日まで：</span>鬼武者オススメ期間。</li>
                                        <li><span class="font-bold text-gray-900">27日(木)：</span><span class="text-indigo-600 font-bold">月周年日2nd</span>。ポンコツ珍道中（まりもさん、ガットさん、いち花さん）＋七咲ななさん収録。PS共に環境・出玉を徹底アピール！</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- 11/28 Special -->
                            <div class="ml-8 pl-4 relative">
                                <div class="absolute -left-14 sm:-left-14 top-1 w-8 h-8 bg-red-600 rounded-full border-4 border-red-100 shadow-sm animate-pulse"></div>
                                <h4 class="text-2xl font-extrabold text-red-600">11/28 (金) <span class="text-base font-bold text-gray-800 ml-2">年一「1128」× 8の日</span></h4>
                                <div class="mt-3 bg-gradient-to-r from-yellow-50 to-white p-6 rounded-xl shadow-lg border-2 border-yellow-400">
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        <span class="bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full">最重要</span>
                                        <span class="bg-black text-white text-xs font-bold px-3 py-1 rounded-full">お祭り</span>
                                    </div>
                                    <h5 class="text-lg font-bold text-gray-900 mb-2">八潮上空 / 真骨超 / くずパチ収録</h5>
                                    <p class="text-gray-700 leading-relaxed text-sm">
                                        年一の祭りの日。いつもの集大成を見せる時です。<br>
                                        <strong class="text-red-600">【真骨超】</strong>月に一度の特別スロット取材。<br>
                                        <strong class="text-indigo-600">【くずパチ】</strong>久々の自店収録。パチンコファン多数来店予想。告知徹底をお願いします！
                                    </p>
                                </div>
                            </div>

                            <!-- 11/29 - 30 -->
                            <div class="ml-8 pl-4 relative">
                                <div class="absolute -left-14 sm:-left-14 top-1 w-8 h-8 bg-green-500 rounded-full border-4 border-white"></div>
                                <h4 class="text-xl font-bold text-gray-800">11/29 (土) ～ 30 (日) <span class="text-sm font-normal text-gray-600 ml-2">週末豪華来店ラッシュ</span></h4>
                                <div class="mt-3 bg-white p-5 rounded-xl shadow-md border border-gray-200">
                                    <div class="space-y-3">
                                        <div class="border-b border-gray-100 pb-2">
                                            <span class="font-bold text-green-700">29日(土)</span>
                                            <span class="text-gray-800 text-sm ml-2">天草さん ＋ くろむさん</span>
                                            <p class="text-xs text-gray-500 mt-1">スロットメイン。「塊」への期待大。</p>
                                        </div>
                                        <div>
                                            <span class="font-bold text-purple-700">30日(日)</span>
                                            <span class="text-gray-800 text-sm ml-2">スロパチfor埼玉 / MAXBET(トモさん) / 千咲ななさん</span>
                                            <p class="text-xs text-gray-500 mt-1">ジャグラーの列、AT機種の盛り上がりに期待。</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </details>
            </div>
        </section>

        <section class="py-20 bg-white">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="max-w-6xl mx-auto">
                    <div class="text-center mb-12">
                        <h2 id="calendarTitle" class="text-3xl font-extrabold tracking-tight text-gray-900 sm:text-4xl">本日のイベント</h2>
                        <p id="calendarSubtitle" class="mt-4 max-w-2xl mx-auto text-lg text-gray-600">下のボタンから11月全体のカレンダーも確認できます。</p>
                    </div>
                    <div id="calendarWrapper" class="bg-white rounded-2xl shadow-lg border border-gray-200/80 overflow-hidden">
                        <div id="todayEventContainer" class="p-6 sm:p-8"><p class="text-center text-gray-500">カレンダー情報を読み込んでいます...</p></div>
                        <div id="fullCalendarContainer" class="hidden p-4 sm:p-6">
                            <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-center">
                                <div class="text-xs font-semibold text-gray-500 py-2">日</div>
                                <div class="text-xs font-semibold text-gray-500 py-2">月</div>
                                <div class="text-xs font-semibold text-gray-500 py-2">火</div>
                                <div class="text-xs font-semibold text-gray-500 py-2">水</div>
                                <div class="text-xs font-semibold text-gray-500 py-2">木</div>
                                <div class="text-xs font-semibold text-gray-500 py-2">金</div>
                                <div class="text-xs font-semibold text-gray-500 py-2">土</div>
                            </div>
                            <div id="selectedEventDetails" class="mt-6 border-t border-gray-200 pt-6"></div>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="calendarToggleButton" class="btn-primary bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                            11月のカレンダー全体を見る
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-20 bg-slate-50">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-extrabold tracking-tight text-gray-900 sm:text-4xl">フロアマップ</h2>
                    <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-600">店内の設置機種をご確認いただけます。</p>
                </div>
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-200/80 p-4">
                         <img src="simazu.jpg" alt="ガーデン八潮店フロアマップ" class="rounded-xl w-full h-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                         <div style="display: none; padding: 20px; background-color: #eee; color: #555; text-align: center; border-radius: 1rem;">フロアマップが表示できません</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-white">
        <div class="container mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-base text-gray-500">&copy; 2025 ガーデン八潮総合BOT. All rights reserved.</p>
        </div>
    </footer>

    <!-- 新装開店モーダル -->
    <div id="newOpeningModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">2025/11/05 新装開店</h3>
                <button id="closeNewOpeningModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div id="newOpeningInfo" class="p-6 max-h-[70vh] overflow-y-auto text-left">
                <p class="text-center text-gray-500">新装開店の情報を読み込んでいます...</p>
            </div>
        </div>
    </div>

    <!-- 機種詳細モーダル (Z-indexを高く設定) -->
    <div id="machineDetailModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[85vh] flex flex-col">
            <!-- Header -->
            <div class="bg-indigo-600 p-4 sm:p-6 flex justify-between items-start shrink-0">
                <h3 id="detailName" class="text-xl sm:text-2xl font-bold text-white leading-tight pr-4"></h3>
                <button id="closeDetailModal" class="text-indigo-100 hover:text-white text-3xl font-bold leading-none">&times;</button>
            </div>
            
            <!-- Body -->
            <div class="p-6 overflow-y-auto">
                <!-- Sales Pitch -->
                <div class="mb-8">
                    <h4 class="text-sm font-bold text-indigo-500 uppercase tracking-wide mb-2">セールスポイント</h4>
                    <p id="detailPitch" class="text-gray-800 text-lg leading-relaxed font-medium"></p>
                </div>

                <!-- Pros & Cons Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Pros -->
                    <div class="bg-green-50 rounded-xl p-5 border border-green-100">
                        <div class="flex items-center mb-3 text-green-700">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <h5 class="font-bold">GOOD（ここが良い！）</h5>
                        </div>
                        <ul id="detailPros" class="space-y-2 text-green-900 text-sm font-medium"></ul>
                    </div>

                    <!-- Cons -->
                    <div class="bg-red-50 rounded-xl p-5 border border-red-100">
                        <div class="flex items-center mb-3 text-red-700">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            <h5 class="font-bold">BAD（ここは注意！）</h5>
                        </div>
                        <ul id="detailCons" class="space-y-2 text-red-900 text-sm font-medium"></ul>
                    </div>
                </div>

                <!-- Link -->
                <div class="text-center">
                    <a id="detailLink" href="#" target="_blank" class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 transition-colors">
                        スペック詳細を見る (DMMぱちタウン)
                        <svg class="ml-2 -mr-1 w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"></path><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"></path></svg>
                    </a>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase設定 ---
        const firebaseConfig = {
          apiKey: "AIzaSyAdxAeBlJkFWAVM1ZWJKhU2urQcmtL0UKo",
          authDomain: "gardenyashiobot.firebaseapp.com",
          projectId: "gardenyashiobot",
          storageBucket: "gardenyashiobot.firebasestorage.app",
          messagingSenderId: "692971442685",
          appId: "1:692971442685:web:ae4a65988ad1716ed84994"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const machinesCol = collection(db, "machines");
        const newOpeningCol = collection(db, "newOpening");
        const calendarCol = collection(db, "calendar");

        // --- グローバル変数・状態 ---
        let allMachines = [];
        let newOpeningData = [];
        let calendarEvents = [];
        let eventMap = new Map();

        const specTypes = ['すべて', 'スロット', 'パチンコ', 'ミドル', 'ライトミドル', '甘デジ', 'AT', 'A-TYPE'];
        let activeSpecFilter = 'すべて';

        let isFullCalendarView = false;
        let selectedDate = -1;
        const today = new Date();
        const currentMonth = today.getMonth(); // 11月は 10
        const currentDate = today.getDate();

        // 2025年11月設定
        const firstDayOfNov2025 = 6; // 2025年11月1日は土曜日(6)
        const daysInNov = 30;

        let slideIndex = 0;
        let slideInterval;
        const slideChangeInterval = 5000;

        // --- DOM要素キャッシュ ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const elements = {
            newOpeningButton: $('#newOpeningButton'),
            newOpeningModal: $('#newOpeningModal'),
            closeNewOpeningModal: $('#closeNewOpeningModal'),
            newOpeningInfo: $('#newOpeningInfo'),
            
            // Detail Modal Elements
            machineDetailModal: $('#machineDetailModal'),
            closeDetailModal: $('#closeDetailModal'),
            detailName: $('#detailName'),
            detailPitch: $('#detailPitch'),
            detailPros: $('#detailPros'),
            detailCons: $('#detailCons'),
            detailLink: $('#detailLink'),

            currentDateEl: $('#currentDate'),
            todayEventContainer: $('#todayEventContainer'),
            fullCalendarContainer: $('#fullCalendarContainer'),
            calendarGrid: $('#calendarGrid'),
            selectedEventDetails: $('#selectedEventDetails'),
            calendarToggleButton: $('#calendarToggleButton'),
            calendarTitle: $('#calendarTitle'),
            calendarSubtitle: $('#calendarSubtitle'),
            sliderWrapper: $('.slider-wrapper'),
            slides: $$('.slide'),
            dots: $$('.dot'),
            prevButton: $('.prev'),
            nextButton: $('.next')
        };
        const totalSlides = elements.slides.length;

        // --- ユーティリティ関数 ---
        function toHiragana(str) {
            return str.replace(/[\u30a1-\u30f6]/g, match => String.fromCharCode(match.charCodeAt(0) - 0x60));
        }

        // --- データ取得 ---
        async function fetchAllData() {
            try {
                const machinesQuery = query(machinesCol, orderBy("name", "asc"));
                const machineSnapshot = await getDocs(machinesQuery);
                allMachines = machineSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));

                const newOpeningQuery = query(newOpeningCol, orderBy("count", "desc"));
                const newOpeningSnapshot = await getDocs(newOpeningCol);
                newOpeningData = newOpeningSnapshot.docs.map(doc => doc.data());

                const calendarQuery = query(calendarCol, orderBy("date", "asc"));
                const calendarSnapshot = await getDocs(calendarQuery);
                calendarEvents = calendarSnapshot.docs.map(doc => doc.data());

                eventMap = new Map(calendarEvents.map(event => [event.date, event]));

                if(elements.newOpeningInfo) elements.newOpeningInfo.innerHTML = '';

                renderTodayView();

            } catch (error) {
                if(elements.todayEventContainer) elements.todayEventContainer.innerHTML = `<p class="text-red-500 text-center">エラー: カレンダーを読み込めませんでした。</p>`;
            }
        }

        // --- 詳細モーダル機能 ---
        function openMachineDetail(machine) {
            // データセット
            if(elements.detailName) elements.detailName.textContent = machine.name;
            if(elements.detailPitch) elements.detailPitch.textContent = machine.salesPitch || "詳細情報は現在準備中です。";
            
            // Pros
            if(elements.detailPros) {
                elements.detailPros.innerHTML = '';
                if (machine.pros && machine.pros.length > 0) {
                    machine.pros.forEach(point => {
                        const li = document.createElement('li');
                        li.textContent = point;
                        elements.detailPros.appendChild(li);
                    });
                } else {
                    elements.detailPros.innerHTML = '<li>情報なし</li>';
                }
            }

            // Cons
            if(elements.detailCons) {
                elements.detailCons.innerHTML = '';
                if (machine.cons && machine.cons.length > 0) {
                    machine.cons.forEach(point => {
                        const li = document.createElement('li');
                        li.textContent = point;
                        elements.detailCons.appendChild(li);
                    });
                } else {
                    elements.detailCons.innerHTML = '<li>情報なし</li>';
                }
            }

            // Link
            if(elements.detailLink) {
                if(machine.specUrl) {
                    elements.detailLink.href = machine.specUrl;
                    elements.detailLink.style.display = 'inline-flex';
                } else {
                    elements.detailLink.style.display = 'none';
                }
            }

            // 表示
            elements.machineDetailModal.classList.remove('hidden');
        }

        // --- 新装開店モーダル機能 ---
        function openNewOpeningModal() {
            if (!elements.newOpeningInfo) return;
            elements.newOpeningInfo.innerHTML = '';

            const createList = (title, machines) => {
                if (machines.length === 0) return null;
                const section = document.createElement('div');
                const header = document.createElement('h4');
                header.className = 'text-lg font-bold text-gray-800 mb-3';
                header.textContent = title;
                section.appendChild(header);
                const ul = document.createElement('ul');
                ul.className = 'space-y-2 mb-6';
                machines.forEach(openingMachine => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-50 p-3 rounded-lg border hover:bg-slate-100 transition-colors';

                    // 名前マッチング (DBのデータと照合)
                    const matchedMachine = allMachines.find(rm => rm.name === openingMachine.name);

                    // クリック可能か判定
                    let nameElement;
                    if (matchedMachine && matchedMachine.salesPitch) {
                        nameElement = document.createElement('button');
                        nameElement.className = 'text-left text-indigo-600 font-bold hover:underline focus:outline-none';
                        nameElement.onclick = () => openMachineDetail(matchedMachine);
                        // ツールチップ的なものを追加しても良いがシンプルに
                        nameElement.innerHTML = `${openingMachine.name} <span class="text-xs text-indigo-400 font-normal ml-1">▶詳細</span>`;
                    } else {
                        nameElement = document.createElement('span');
                        nameElement.className = 'text-gray-800 font-medium';
                        nameElement.textContent = openingMachine.name;
                    }

                    const countElement = document.createElement('span');
                    countElement.className = 'font-semibold text-white bg-indigo-600 px-2 py-1 text-sm rounded-md ml-2 shrink-0';
                    countElement.textContent = `${openingMachine.count}台`;
                    
                    li.appendChild(nameElement);
                    li.appendChild(countElement);
                    ul.appendChild(li);
                });
                section.appendChild(ul);
                return section;
            };

            if (newOpeningData.length === 0) {
                 elements.newOpeningInfo.innerHTML = `<p class="text-gray-500 text-center">現在、新装開店の情報はありません。</p>`;
            } else {
                const pachinkoList = createList('パチンコ', newOpeningData.filter(m => m.type === 'P'));
                const slotList = createList('スロット', newOpeningData.filter(m => m.type === 'S'));
                if (pachinkoList) elements.newOpeningInfo.appendChild(pachinkoList);
                if (slotList) elements.newOpeningInfo.appendChild(slotList);
                if (!pachinkoList && !slotList) {
                    elements.newOpeningInfo.innerHTML = `<p class="text-gray-500 text-center">新装開店の情報は現在ありません。</p>`;
                }
            }
            if (elements.newOpeningModal) elements.newOpeningModal.classList.remove('hidden');
        }

        // --- 画像スライダー機能 ---
        function updateSlider() {
            if (!elements.sliderWrapper) return;
            elements.sliderWrapper.style.transform = `translateX(${-slideIndex * 100}%)`;
            elements.dots.forEach((dot, index) => dot.classList.toggle('active', index === slideIndex));
        }
        function changeSlide(n) {
            if (totalSlides === 0) return;
            slideIndex = (slideIndex + n + totalSlides) % totalSlides;
            updateSlider();
            resetSlideInterval();
        }
        function currentSlide(n) {
            if (totalSlides === 0) return;
            slideIndex = n;
            updateSlider();
            resetSlideInterval();
        }
        function startSlideInterval() {
            if (totalSlides <= 1) return;
            clearInterval(slideInterval);
            slideInterval = setInterval(() => changeSlide(1), slideChangeInterval);
        }
        function resetSlideInterval() {
            clearInterval(slideInterval);
            startSlideInterval();
        }
        function initSlider() {
            if (totalSlides > 0) {
                if (elements.prevButton) elements.prevButton.addEventListener('click', () => changeSlide(-1));
                if (elements.nextButton) elements.nextButton.addEventListener('click', () => changeSlide(1));
                elements.dots.forEach((dot, index) => {
                    dot.addEventListener('click', () => currentSlide(index));
                });
                updateSlider();
                startSlideInterval();
            }
            if (totalSlides <= 1) {
                if (elements.prevButton) elements.prevButton.style.display = 'none';
                if (elements.nextButton) elements.nextButton.style.display = 'none';
                if ($('.dots-container')) $('.dots-container').style.display = 'none';
            }
        }

        // --- カレンダー機能 ---
        function setFormattedDate() {
            if (!elements.currentDateEl) return;
            const day = ['日', '月', '火', '水', '木', '金', '土'][today.getDay()];
            elements.currentDateEl.textContent = `${today.getFullYear()}年 ${today.getMonth() + 1}月${today.getDate()}日 (${day})`;
        }

        function getEventDetailsHTML(date) {
            const event = eventMap.get(date);
            let detailsHTML = '';
            if (!event || (!event.p_event && !event.s_event && !event.recommend)) {
                detailsHTML = '<li class="text-gray-500">この日の特別イベントはありません。</li>';
            } else {
                if (event.p_event) detailsHTML += `<li class="text-gray-700">${event.p_event}</li>`;
                if (event.s_event) detailsHTML += `<li class="text-gray-700">${event.s_event}</li>`;
                if (event.recommend) detailsHTML += `<li class="text-gray-700">${event.recommend}</li>`;
            }
            const dayOfWeek = event ? event.day : new Date(2025, 10, date).toLocaleString('ja-JP', { weekday: 'short' });
            return `
                <h3 class="font-bold text-xl text-indigo-700 mb-4">11月 ${date}日 (${dayOfWeek})</h3>
                <ul class="space-y-2 list-disc list-inside">${detailsHTML}</ul>
            `;
        }

        function renderTodayView() {
            if (!elements.todayEventContainer) return;
            if (eventMap.size === 0) {
                elements.todayEventContainer.innerHTML = `<p class="text-center text-gray-500">カレンダー情報を読み込んでいます...</p>`;
                return;
            }
            if (currentMonth !== 10) { // 10 = 11月
                elements.todayEventContainer.innerHTML = `<div class="p-4 text-center text-gray-500">11月のイベントカレンダーです。現在、対象月ではありません。</div>`;
                if(elements.calendarTitle) elements.calendarTitle.textContent = 'イベントカレンダー';
                if(elements.calendarSubtitle) elements.calendarSubtitle.textContent = '11月のイベント情報です。';
            } else {
                selectedDate = currentDate;
                elements.todayEventContainer.innerHTML = `<div class="p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg">${getEventDetailsHTML(currentDate)}</div>`;
            }
        }

        function renderFullCalendarGrid() {
            if (!elements.calendarGrid) return;
            let gridHTML = `
                <div class="text-xs font-semibold text-gray-500 py-2">日</div>
                <div class="text-xs font-semibold text-gray-500 py-2">月</div>
                <div class="text-xs font-semibold text-gray-500 py-2">火</div>
                <div class="text-xs font-semibold text-gray-500 py-2">水</div>
                <div class="text-xs font-semibold text-gray-500 py-2">木</div>
                <div class="text-xs font-semibold text-gray-500 py-2">金</div>
                <div class="text-xs font-semibold text-gray-500 py-2">土</div>
            `;
            for (let i = 0; i < firstDayOfNov2025; i++) {
                gridHTML += `<div class="calendar-day empty-day"></div>`;
            }
            for (let date = 1; date <= daysInNov; date++) {
                const event = eventMap.get(date);
                const hasEvent = event && (event.p_event || event.s_event || event.recommend);
                const isToday = (currentMonth === 10 && date === currentDate);
                const isSelected = (date === selectedDate);
                let classes = 'calendar-day';
                if (hasEvent) classes += ' has-event';
                if (isToday) classes += ' is-today';
                if (isSelected) classes += ' is-selected';
                gridHTML += `<button class="${classes}" data-date="${date}">${date}</button>`;
            }
            elements.calendarGrid.innerHTML = gridHTML;

            if (elements.selectedEventDetails) {
                elements.selectedEventDetails.innerHTML = (currentMonth === 10)
                    ? getEventDetailsHTML(selectedDate)
                    : `<p class="text-center text-gray-500">11月のイベントカレンダーです。</p>`;
            }
        }

        function handleDateClick(e) {
            const target = e.target.closest('.calendar-day');
            if (!target || target.classList.contains('empty-day')) return;
            const date = parseInt(target.dataset.date, 10);
            if (isNaN(date)) return;
            selectedDate = date;
            renderFullCalendarGrid();
            if (elements.selectedEventDetails) {
                elements.selectedEventDetails.innerHTML = getEventDetailsHTML(date);
            }
        }

        function toggleCalendarView() {
            isFullCalendarView = !isFullCalendarView;
            elements.todayEventContainer?.classList.toggle('hidden', isFullCalendarView);
            elements.fullCalendarContainer?.classList.toggle('hidden', !isFullCalendarView);
            if (elements.calendarToggleButton) {
                elements.calendarToggleButton.textContent = isFullCalendarView ? '本日のイベントに戻る' : '11月のカレンダー全体を見る';
            }
            if (elements.calendarTitle) {
                elements.calendarTitle.textContent = isFullCalendarView ? '11月のイベントカレンダー' : '本日のイベント';
            }
            if (elements.calendarSubtitle) {
                elements.calendarSubtitle.textContent = isFullCalendarView ? '日付をタップすると詳細が表示されます。' : '11月全体のカレンダーも確認できます。';
            }
            if (isFullCalendarView) {
                renderFullCalendarGrid();
            }
        }

        function initCalendar() {
            setFormattedDate();
            if (elements.calendarToggleButton) elements.calendarToggleButton.addEventListener('click', toggleCalendarView);
            if (elements.calendarGrid) elements.calendarGrid.addEventListener('click', handleDateClick);
        }

        // --- モーダル初期化 ---
        function initModals() {
            // New Opening
            if (elements.newOpeningButton) elements.newOpeningButton.addEventListener('click', openNewOpeningModal);
            if (elements.closeNewOpeningModal) elements.closeNewOpeningModal.addEventListener('click', () => elements.newOpeningModal.classList.add('hidden'));
            if (elements.newOpeningModal) elements.newOpeningModal.addEventListener('click', (e) => { if (e.target === elements.newOpeningModal) elements.newOpeningModal.classList.add('hidden'); });

            // Detail Modal
            if (elements.closeDetailModal) elements.closeDetailModal.addEventListener('click', () => elements.machineDetailModal.classList.add('hidden'));
            if (elements.machineDetailModal) elements.machineDetailModal.addEventListener('click', (e) => { if (e.target === elements.machineDetailModal) elements.machineDetailModal.classList.add('hidden'); });
        }

        // --- 画像エラー処理 ---
        function initErrorHandlers() {
            $$('.slide img').forEach(img => {
                img.onerror = function() {
                    const placeholder = document.createElement('div');
                    placeholder.textContent = `${this.alt || '画像'}が表示できません`;
                    placeholder.style.cssText = `display: flex; align-items: center; justify-content: center; height: 100%; background-color: #111; color: #777; text-align: center; width: 100%;`;
                    this.parentNode.replaceChild(placeholder, this);
                };
            });
            $('img[src="simazu.jpg"]').onerror = function() {
                const placeholder = document.createElement('div');
                placeholder.textContent = 'フロアマップが表示できません';
                placeholder.style.cssText = `display: flex; align-items: center; justify-content: center; height: 300px; background-color: #eee; color: #555; text-align: center; border-radius: 1rem; width: 100%;`;
                this.parentNode.replaceChild(placeholder, this);
            };
            $('img[src="rogo.jpg"]').onerror = function() { this.style.display = 'none'; };
        }

        // --- アプリケーション初期化 ---
        function init() {
            fetchAllData();
            initCalendar();
            initSlider();
            initModals();
            initErrorHandlers();
        }

        window.addEventListener('load', init);

    </script>
</body>
</html>
